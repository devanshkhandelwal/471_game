<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A-B Effort Game</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React and ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel Standalone for JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
      /* Prevent text selection during rapid tapping */
      button {
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
      }
      /* Better touch targets for mobile */
      @media (max-width: 640px) {
        button {
          min-height: 80px;
        }
      }
    </style>
</head>
<body>
    <div id="root">
        <div style="padding: 20px; text-align: center;">
            <p>Loading...</p>
        </div>
    </div>

    <script type="text/babel">
        // Check if React is loaded
        if (typeof React === 'undefined' || typeof ReactDOM === 'undefined') {
            document.getElementById('root').innerHTML = '<div style="padding: 20px; text-align: center; color: red;"><h1>Error: React not loaded</h1><p>Please check your internet connection and refresh the page.</p></div>';
            throw new Error('React or ReactDOM not loaded');
        }
        const { useState, useEffect, useRef, useCallback } = React;

        /**
         * ABEffortGame - A behavioral economics demo game
         * 
         * Users alternate pressing A and B keys as fast as possible for 15 seconds.
         * Two rounds: Round 1 (no incentive) and Round 2 (with incentive).
         * After both rounds, users can save their scores to a leaderboard.
         */
        function ABEffortGame() {
          // Login state
          const [isLoggedIn, setIsLoggedIn] = useState(false);
          const [playerName, setPlayerName] = useState('');
          const [nameInput, setNameInput] = useState('');
          
          // Game state
          const [currentRound, setCurrentRound] = useState(1); // 1 or 2
          const [isRoundActive, setIsRoundActive] = useState(false);
          const [timeRemaining, setTimeRemaining] = useState(15);
          const [score, setScore] = useState(0);
          const [previousKey, setPreviousKey] = useState(null); // 'A' or 'B' or null
          const [round1Score, setRound1Score] = useState(null);
          const [round2Score, setRound2Score] = useState(null);
          const [roundComplete, setRoundComplete] = useState(false);
          
          // Score saved state
          const [scoreSaved, setScoreSaved] = useState(false);
          
          // Timer ref to ensure cleanup
          const timerRef = useRef(null);

          /**
           * Handles key/button press - shared logic for both keyboard and button clicks
           * 
           * Alternation logic:
           * - Only A and B keys are valid (case-insensitive)
           * - Score increments only when the pressed key is different from the previous valid key
           * - A complete alternation (A→B or B→A) counts as 1 point
           * - The first key press doesn't count; we need a complete alternation to score
           * - Repeated keys (A→A or B→B) are ignored
           */
          const handleKeyPress = useCallback((key) => {
            if (!isRoundActive) return;
            
            const upperKey = key.toUpperCase();
            
            // Only process A and B keys
            if (upperKey !== 'A' && upperKey !== 'B') return;
            
            // Use functional updates to avoid stale closure issues
            setPreviousKey(prevKey => {
              // Check for valid alternation
              // Only increment if we have a previous key AND it's different (complete alternation)
              if (prevKey !== null && prevKey !== upperKey) {
                // Valid alternation: increment score and update previous key
                setScore(prev => prev + 1);
                return upperKey;
              } else if (prevKey === null) {
                // First key press: just set previousKey, don't increment score
                return upperKey;
              }
              // If prevKey === upperKey, it's a repeat, so we ignore it and return same key
              return prevKey;
            });
          }, [isRoundActive]);

          /**
           * Keyboard event handler
           */
          useEffect(() => {
            if (!isRoundActive) return;

            const handleKeyboardPress = (event) => {
              handleKeyPress(event.key);
            };

            window.addEventListener('keydown', handleKeyboardPress);
            return () => {
              window.removeEventListener('keydown', handleKeyboardPress);
            };
          }, [isRoundActive, handleKeyPress]);

          /**
           * Timer management:
           * - Runs every second when round is active
           * - Decrements timeRemaining from 15 to 0
           * - When timer reaches 0, stops the round and saves the score
           * - Cleanup function ensures interval is cleared to prevent memory leaks
           */
          useEffect(() => {
            if (isRoundActive && timeRemaining > 0) {
              timerRef.current = setInterval(() => {
                setTimeRemaining(prev => {
                  if (prev <= 1) {
                    // Timer reached 0, stop the round
                    setIsRoundActive(false);
                    return 0;
                  }
                  return prev - 1;
                });
              }, 1000);
            } else {
              // Clean up interval when round is not active
              if (timerRef.current) {
                clearInterval(timerRef.current);
                timerRef.current = null;
              }
            }

            return () => {
              if (timerRef.current) {
                clearInterval(timerRef.current);
              }
            };
          }, [isRoundActive, timeRemaining]);

          /**
           * When round completes, save the score and mark round as complete
           */
          useEffect(() => {
            if (!isRoundActive && timeRemaining === 0 && !roundComplete) {
              if (currentRound === 1) {
                setRound1Score(score);
              } else if (currentRound === 2) {
                setRound2Score(score);
              }
              setRoundComplete(true);
            }
          }, [isRoundActive, timeRemaining, roundComplete, currentRound, score]);

          /**
           * Starts a new round
           */
          const startRound = () => {
            setIsRoundActive(true);
            setTimeRemaining(15);
            setScore(0);
            setPreviousKey(null);
            setRoundComplete(false);
          };

          /**
           * Moves to the next round
           */
          const continueToRound2 = () => {
            setCurrentRound(2);
            setIsRoundActive(false);
            setTimeRemaining(15);
            setScore(0);
            setPreviousKey(null);
            setRoundComplete(false);
          };

          /**
           * Login handler
           */
          const handleLogin = () => {
            if (nameInput.trim()) {
              setPlayerName(nameInput.trim());
              setIsLoggedIn(true);
            }
          };

          /**
           * Auto-save score when both rounds complete
           */
          const autoSaveScore = async () => {
            if (!playerName.trim() || round1Score === null || round2Score === null) {
              return;
            }

            try {
              const response = await fetch(`${window.location.origin}/api/scores`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  name: playerName.trim(),
                  round1Score: round1Score,
                  round2Score: round2Score
                })
              });

              if (response.ok) {
                setScoreSaved(true);
              }
            } catch (error) {
              console.error('Error saving score:', error);
            }
          };

          /**
           * Auto-save when both rounds are complete
           */
          useEffect(() => {
            if (round1Score !== null && round2Score !== null && !scoreSaved) {
              autoSaveScore();
            }
          }, [round1Score, round2Score, scoreSaved, playerName]);

          // Calculate delta for display
          const delta = round1Score !== null && round2Score !== null 
            ? round2Score - round1Score 
            : null;


          // Determine if both rounds are complete
          const bothRoundsComplete = round1Score !== null && round2Score !== null;

          // Login screen
          if (!isLoggedIn) {
            return (
              <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
                <div className="bg-white rounded-lg shadow-xl p-8 max-w-md w-full">
                  <h1 className="text-4xl font-bold text-center text-gray-800 mb-6">
                    A-B Effort Game
                  </h1>
                  <div className="mb-6">
                    <label className="block text-gray-700 font-medium mb-2">
                      Enter your name
                    </label>
                    <input
                      type="text"
                      value={nameInput}
                      onChange={(e) => setNameInput(e.target.value)}
                      placeholder="Your name"
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                      onKeyPress={(e) => {
                        if (e.key === 'Enter') {
                          handleLogin();
                        }
                      }}
                      autoFocus
                    />
                  </div>
                  <button
                    onClick={handleLogin}
                    disabled={!nameInput.trim()}
                    className="w-full px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors"
                  >
                    Start Game
                  </button>
                </div>
              </div>
            );
          }

          return (
            <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
              <div className="max-w-6xl mx-auto">
                <div className="bg-white rounded-lg shadow-xl p-8 mb-6">
                {/* Title */}
                <h1 className="text-4xl font-bold text-center text-gray-800 mb-2">
                  A-B Effort Game
                </h1>
                <p className="text-center text-sm text-gray-600 mb-6">
                  Playing as: <span className="font-semibold text-indigo-600">{playerName}</span>
                </p>

                {/* Instructions */}
                <div className="mb-6 text-center text-gray-700">
                  <p className="mb-2">
                    Press <span className="font-semibold">A</span> and <span className="font-semibold">B</span> alternately as fast as you can for 15 seconds.
                  </p>
                  <p className="text-sm text-gray-600">
                    Only alternating presses count (A to B to A to B...).
                  </p>
                </div>

                {/* Round indicator */}
                <div className="mb-6 p-4 bg-gray-50 rounded-lg text-center">
                  {currentRound === 1 ? (
                    <p className="text-gray-700 font-medium">
                      Round 1
                    </p>
                  ) : (
                    <p className="text-gray-700 font-medium">
                      Round 2 - The fastest can choose a prize.
                    </p>
                  )}
                </div>

                {/* Score display */}
                <div className="mb-6 text-center">
                  <div className="text-6xl font-bold text-indigo-600 mb-2">
                    {score}
                  </div>
                  <div className="text-lg text-gray-600">
                    Alternations
                  </div>
                </div>

                {/* Timer */}
                <div className="mb-6 text-center">
                  <div className="text-3xl font-semibold text-gray-800">
                    {timeRemaining}s
                  </div>
                </div>

                {/* A and B Buttons (for mobile/touch users) */}
                {isRoundActive && (
                  <div className="mb-6 flex gap-4 justify-center">
                    <button
                      onClick={() => handleKeyPress('A')}
                      className="flex-1 max-w-xs py-8 px-6 bg-red-500 hover:bg-red-600 active:bg-red-700 text-white text-4xl font-bold rounded-xl shadow-lg transition-all transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed touch-manipulation"
                      disabled={!isRoundActive}
                    >
                      A
                    </button>
                    <button
                      onClick={() => handleKeyPress('B')}
                      className="flex-1 max-w-xs py-8 px-6 bg-blue-500 hover:bg-blue-600 active:bg-blue-700 text-white text-4xl font-bold rounded-xl shadow-lg transition-all transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed touch-manipulation"
                      disabled={!isRoundActive}
                    >
                      B
                    </button>
                  </div>
                )}

                {/* Instructions for buttons */}
                {!isRoundActive && (
                  <div className="mb-6 text-center text-sm text-gray-500">
                    Use keyboard A/B keys or tap the buttons above when the round starts
                  </div>
                )}

                {/* Round summary (shown when round completes) */}
                {roundComplete && (
                  <div className="mb-6 p-4 bg-indigo-50 rounded-lg text-center">
                    <p className="text-gray-800 font-medium mb-2">
                      Finished with {currentRound === 1 ? round1Score : round2Score} alternations.
                    </p>
                    {currentRound === 2 && delta !== null && (
                      <p className="text-gray-700">
                        You {delta >= 0 ? 'increased' : 'decreased'} your effort by{' '}
                        <span className={`font-semibold ${delta >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                          {delta >= 0 ? '+' : ''}{delta}
                        </span>{' '}
                        compared to Round 1
                      </p>
                    )}
                  </div>
                )}

                {/* Control buttons */}
                <div className="mb-6 text-center">
                  {!bothRoundsComplete && (
                    <>
                      {currentRound === 1 && !roundComplete && (
                        <button
                          onClick={startRound}
                          disabled={isRoundActive}
                          className="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors"
                        >
                          Start
                        </button>
                      )}
                      {currentRound === 1 && roundComplete && (
                        <button
                          onClick={continueToRound2}
                          className="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition-colors"
                        >
                          Continue
                        </button>
                      )}
                      {currentRound === 2 && !roundComplete && (
                        <button
                          onClick={startRound}
                          disabled={isRoundActive}
                          className="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors"
                        >
                          Start
                        </button>
                      )}
                    </>
                  )}
                </div>

                {/* Score saved confirmation */}
                {bothRoundsComplete && scoreSaved && (
                  <div className="mt-8 border-t pt-8 text-center">
                    <p className="text-gray-700 font-medium mb-2">
                      Your score has been saved! View the <a href="/leaderboard" className="text-indigo-600 underline">leaderboard</a>.
                    </p>
                  </div>
                )}
                </div>
              </div>
            </div>
          );
        }

        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ABEffortGame />);
    </script>
</body>
</html>

